name: Deploy API to Infomaniak

on:
  push:
    branches: ['main']
  workflow_dispatch:

concurrency:
  group: deploy-api-infomaniak-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      SSH_HOST: ${{ secrets.INFOMANIAK_SSH_HOST }}
      SSH_PORT: ${{ secrets.INFOMANIAK_SSH_PORT }}
      SSH_USERNAME: ${{ secrets.INFOMANIAK_SSH_USERNAME }}
      SSH_PRIVATE_KEY: ${{ secrets.INFOMANIAK_SSH_PRIVATE_KEY }}
      SSH_PASSWORD: ${{ secrets.INFOMANIAK_SSH_PASSWORD }}
      TARGET_DIR: ${{ secrets.INFOMANIAK_TARGET_DIR }}
      POST_DEPLOY_COMMAND: ${{ secrets.INFOMANIAK_POST_DEPLOY_COMMAND }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.6.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate API
        run: |
          pnpm --filter @nyvoro/api typecheck
          pnpm --filter @nyvoro/api test
          pnpm --filter @nyvoro/api build

      - name: Prepare deployment payload
        run: |
          set -eu
          rm -rf .deploy
          mkdir -p .deploy/api/apps .deploy/api/packages
          rsync -a --exclude 'node_modules' --exclude 'coverage' --exclude 'dist' apps/api/ .deploy/api/apps/api/
          rsync -a --exclude 'node_modules' packages/shared-types/ .deploy/api/packages/shared-types/
          cp package.json pnpm-lock.yaml pnpm-workspace.yaml tsconfig.base.json .deploy/api/

      - name: Validate deployment secrets
        run: |
          set -eu

          if [ -z "${SSH_HOST}" ] || [ -z "${SSH_USERNAME}" ] || [ -z "${TARGET_DIR}" ]; then
            echo "Missing required Infomaniak SSH secrets."
            echo "Required: INFOMANIAK_SSH_HOST, INFOMANIAK_SSH_USERNAME, INFOMANIAK_TARGET_DIR"
            exit 1
          fi

          if [ -z "${SSH_PRIVATE_KEY}" ] && [ -z "${SSH_PASSWORD}" ]; then
            echo "Provide INFOMANIAK_SSH_PRIVATE_KEY (recommended) or INFOMANIAK_SSH_PASSWORD."
            exit 1
          fi

          if [ -z "${SSH_PORT}" ]; then
            SSH_PORT="22"
          fi

          echo "SSH_PORT=${SSH_PORT}" >> "${GITHUB_ENV}"

      - name: Prepare SSH key authentication
        if: ${{ env.SSH_PRIVATE_KEY != '' }}
        run: |
          set -eu
          mkdir -p "${HOME}/.ssh"
          chmod 700 "${HOME}/.ssh"
          printf '%s\n' "${SSH_PRIVATE_KEY}" > "${HOME}/.ssh/infomaniak_deploy_key"
          chmod 600 "${HOME}/.ssh/infomaniak_deploy_key"
          ssh-keyscan -p "${SSH_PORT}" "${SSH_HOST}" >> "${HOME}/.ssh/known_hosts" 2>/dev/null || true
          chmod 600 "${HOME}/.ssh/known_hosts"

      - name: Install password fallback tooling
        if: ${{ env.SSH_PRIVATE_KEY == '' && env.SSH_PASSWORD != '' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Upload over SSH
        run: |
          set -eu

          if [ -n "${SSH_PRIVATE_KEY}" ]; then
            REMOTE_SSH="ssh -i ${HOME}/.ssh/infomaniak_deploy_key -p ${SSH_PORT} -o StrictHostKeyChecking=accept-new"
            ${REMOTE_SSH} "${SSH_USERNAME}@${SSH_HOST}" "mkdir -p '${TARGET_DIR}'"
            rsync -az --omit-dir-times --no-perms -e "${REMOTE_SSH}" .deploy/api/ "${SSH_USERNAME}@${SSH_HOST}:${TARGET_DIR}/"
            exit 0
          fi

          REMOTE_SSH="ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          sshpass -p "${SSH_PASSWORD}" ${REMOTE_SSH} "${SSH_USERNAME}@${SSH_HOST}" "mkdir -p '${TARGET_DIR}'"
          sshpass -p "${SSH_PASSWORD}" rsync -az --omit-dir-times --no-perms -e "${REMOTE_SSH}" .deploy/api/ "${SSH_USERNAME}@${SSH_HOST}:${TARGET_DIR}/"

      - name: Run post-deploy command over SSH
        run: |
          set -eu

          # npm workspace installs can fail on some Infomaniak Node runtimes.
          # Use a package-scoped install/build command by default.
          DEFAULT_POST_DEPLOY_COMMAND="rm -rf apps/api/node_modules apps/api/package-lock.json && npm install --prefix apps/api --include=dev && npm --prefix apps/api run build"

          if [ -z "${POST_DEPLOY_COMMAND}" ] || printf '%s' "${POST_DEPLOY_COMMAND}" | grep -Eq -- '--workspace[[:space:]]+@nyvoro/api'; then
            POST_DEPLOY_COMMAND="${DEFAULT_POST_DEPLOY_COMMAND}"
          fi

          if [ -n "${SSH_PRIVATE_KEY}" ]; then
            ssh -i "${HOME}/.ssh/infomaniak_deploy_key" \
              -p "${SSH_PORT}" \
              -o StrictHostKeyChecking=accept-new \
              "${SSH_USERNAME}@${SSH_HOST}" \
              "cd '${TARGET_DIR}' && ${POST_DEPLOY_COMMAND}"
            exit 0
          fi

          sshpass -p "${SSH_PASSWORD}" ssh \
            -p "${SSH_PORT}" \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            "${SSH_USERNAME}@${SSH_HOST}" \
            "cd '${TARGET_DIR}' && ${POST_DEPLOY_COMMAND}"
